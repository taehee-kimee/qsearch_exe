# OCR 매칭 최적화 로직 문서

## 개요

이 문서는 Quiz Helper의 OCR 텍스트 매칭 로직 최적화 내용을 기록합니다.
로직 변경 시 참고용으로 사용합니다.

---

## 매칭 흐름

```
OCR 텍스트 입력
    ↓
1단계: 화면 분류 (ClassifyScreen)
    ├─ Question     → 2단계로
    ├─ Answer       → 정답 직접 추출 후 반환
    ├─ SystemMessage → 무시 (null 반환)
    └─ AntiMacro    → 무시 (null 반환)
    ↓
2단계: 전처리
    ├─ 포맷 텍스트 제거 (CleanQuestionText)
    ├─ 글자수 힌트 추출 (ExtractAnswerLength)
    └─ 정규화 (NormalizeText)
    ↓
3단계: 매칭 후보 검색
    ├─ Fuzzy 매칭
    ├─ Choice 매칭 (보기 기반)
    └─ Keyword 매칭
    ↓
4단계: 최종 판단
    └─ 점수 기준 + 점수 차이 기반 판단
```

---

## 1단계: 화면 분류 (ClassifyScreen)

### 화면 타입

| 타입 | 설명 | 처리 |
|------|------|------|
| `Question` | 문제 화면 | DB 매칭 진행 |
| `Answer` | 정답 화면 | 정답 직접 추출 |
| `SystemMessage` | 시스템 메시지 | 무시 |
| `AntiMacro` | 매크로 방지 | 무시 |

### 시스템 메시지 패턴 (IsSystemMessage)

```
- 시상식
- 상금으로.*원을
- 경험치를.*만큼
- 문제를 모두 풀었습니다
- 다시 시작해주세요
- 대단한 실력
- 재널 변경
- 방정보
- "xxx"에 관한 문제입니다 (문장 끝)
```

### 정답 화면 추출 패턴 (TryExtractAnswer)

```
- [정 답] 정답은 XXX
- 정답은 XXX 입니다
```

### 매크로 방지 감지 (IsAntiMacroScreen)

```
- "이미지에 적힌 글자" 패턴
- 유효 문자 비율 < 60%
- 깨진 한글 (자음/모음만) 3개 이상
```

---

## 2단계: 전처리

### 포맷 텍스트 제거 (CleanQuestionText)

| 제거 대상 | 패턴 | 예시 |
|----------|------|------|
| 출제자 정보 | `출제자\s*[:：]\s*\S+` | `출제자 : 큐플레이` |
| 문제 마커 | `\[문제\]`, `<문제\s*\d*>` | `[문제]`, `<문제 6>` |
| 글자수 힌트 | `\(\d+\s*글자\)` | `(4글자)` |
| 정답 형식 | `\(맞다\s*(or\|또는)\s*아니다\)` | `(맞다 or 아니다)` |
| 카테고리 안내 | `"xxx"에 관한 문제입니다` | `"일반상식"에 관한 문제입니다` |

### 글자수 힌트 추출 (ExtractAnswerLength)

```
- (4글자) → 4
- 4글자 → 4
- OOO → 3
- ○○○○ → 4
- 0000라 한다 → 4
```

**활용**: 정답 길이 ±1 글자인 항목만 검색 (후보 필터링)

---

## 3단계: 매칭 방법

### Method 1: Fuzzy 매칭

```csharp
int partialScore = Fuzz.PartialRatio(ocr, question);
int tokenScore = Fuzz.TokenSetRatio(ocr, question);
int weightedScore = Fuzz.WeightedRatio(ocr, question);
int fuzzyScore = Max(partialScore, tokenScore, weightedScore);
```

**길이 페널티**: OCR이 질문보다 5배 이상 길면 점수 감소 (최대 50%)

### Method 2: Choice 매칭 (2024-01 개선)

**이전 로직 (문제점)**:
```
보기가 정답과 일치 → 85~95점 (Fuzzy 무시)
→ 완전히 다른 질문도 높은 점수 받음 (오매칭)
```

**개선된 로직 (방향 A 변형)**:
```
if (Fuzzy >= 60%):
    보기 일치 → Fuzzy + 10점 (보너스)
    질문에 보기 2개+ 포함 → Fuzzy + 15점
else:
    보기 일치 → 최대 70점 (상한)
```

**적용 이유**:
- OCR 오류로 보기 추출이 불완전한 경우 많음
- Choice만으로 높은 점수 주면 오매칭 위험
- Fuzzy 기반으로 안정성 확보

### Method 3: Keyword 매칭

```
한글 2글자 이상 단어 추출 → DB 질문/정답과 비교
매칭률 50% 이상이면 점수 부여
```

---

## 4단계: 최종 판단 (2024-01 개선)

**이전 로직**:
```
점수 >= 80% → 반환
점수 < 80% → 실패
```

**개선된 로직 (방안 2: 점수 차이 기반)**:
```
조건 1: 점수 >= 80% → 반환
조건 2: 점수 >= 65% AND (1위 - 2위) >= 15점 → 반환
그 외: 실패
```

**적용 이유**:
- OCR 품질이 낮아도 1위가 확실히 높으면 정답일 가능성 높음
- 예: 71% (1위) vs 51% (2위) = 20점 차이 → 반환

---

## 개선 히스토리

### 2024-01-30: 화면 분류 및 전처리 추가

**커밋**: `7148bd2`

**변경 내용**:
- `ScreenType` enum 및 `ClassifyScreen()` 함수 추가
- 시스템 메시지, 정답 화면, 매크로 방지 화면 분류
- `CleanQuestionText()` 포맷 텍스트 제거
- `ExtractAnswerLength()` 글자수 힌트 추출 및 필터링

**해결된 문제**:
- 정답 화면에서 불필요한 매칭 시도 → 정답 직접 추출
- 시스템 메시지 무의미한 매칭 → 무시
- 포맷 텍스트로 인한 Fuzzy 점수 하락 → 제거

### 2024-01-30: Choice 제한 및 점수 차이 판단

**커밋**: `dbf0a2a`

**변경 내용**:
- Choice 매칭 로직 수정 (Fuzzy 기반 보너스 방식)
- 점수 차이 기반 최종 판단 로직 추가

**해결된 문제**:

| 케이스 | 이전 | 이후 |
|--------|------|------|
| 피터팬 (Choice 오매칭) | Choice 85% 오답 | Fuzzy 81% 정답 |
| 낭만주의 (기준 과다) | 71% 실패 | 71% (차이 20점) 성공 |

---

## 튜닝 가이드

### 매칭률이 낮을 때

1. **포맷 텍스트 확인**: `CleanQuestionText()` 패턴 추가 필요?
2. **글자수 힌트 허용 오차**: 현재 ±1, 늘려야 할까?
3. **Fuzzy 방식 변경**: `PartialRatio` vs `TokenSetRatio` 가중치

### 오매칭이 많을 때

1. **Choice 보너스 축소**: +10 → +5
2. **점수 차이 기준 상향**: 15점 → 20점
3. **최소 점수 기준 상향**: 65% → 70%

### 기준값 참고

| 항목 | 현재 값 | 조절 범위 |
|------|---------|----------|
| 최소 점수 | 80% | 70~85% |
| 점수 차이 판단 최소 | 65% | 60~75% |
| 점수 차이 기준 | 15점 | 10~20점 |
| Choice 보너스 | +10점 | +5~15점 |
| Choice 단독 상한 | 70점 | 65~75점 |
| Fuzzy 보너스 기준 | 60% | 55~70% |

---

## 관련 파일

- `QuizHelper/Services/CsvDataService.cs`: 매칭 로직 메인
- `QuizHelper/Services/OcrService.cs`: OCR 전처리
- `QuizHelper/Models/QuizData.cs`: 데이터 모델
- `match_log.txt`: 매칭 로그 (디버깅용)
